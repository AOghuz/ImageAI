@{
    ViewData["Title"] = "Nano-Banana Test";
}

<style>
    .container {
        max-width: 800px;
        margin: 40px auto;
    }

    .form-group {
        margin: 20px 0;
    }

    label {
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
    }

    input, textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    button {
        padding: 12px 24px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    #status {
        margin-left: 10px;
    }

    #result {
        margin-top: 20px;
    }

    img {
        max-width: 100%;
        border-radius: 8px;
    }
</style>

<div class="container">
    <h2>Nano-Banana Image Edit</h2>

    <div class="form-group">
        <label>JWT Token</label>
        <input type="password" id="jwt" placeholder="Identity'den aldığın token">
    </div>

    <div class="form-group">
        <label>Görseller</label>
        <input type="file" id="files" multiple accept="image/*">
    </div>

    <div class="form-group">
        <label>Prompt</label>
        <textarea id="prompt" rows="3">make a photo of the man driving the car down the california coastline</textarea>
    </div>

    <div class="form-group">
        <label>Output Format</label>
        <select id="format">
            <option value="">Default</option>
            <option value="jpeg">JPEG</option>
            <option value="png">PNG</option>
        </select>
    </div>

    <button id="runBtn">Gönder</button>
    <span id="status"></span>

    <div id="result"></div>
</div>

@section Scripts {
    <script>
        const API = "https://localhost:7122";

        function getToken() {
            return document.getElementById("jwt").value.trim();
        }

        async function uploadFile(file) {
            const form = new FormData();
            form.append("file", file);

            const res = await fetch(`${API}/api/fal/storage/upload`, {
                method: "POST",
                headers: { Authorization: `Bearer ${getToken()}` },
                body: form
            });

            if (!res.ok) throw new Error(await res.text());
            const json = await res.json();
            return json.file_url;
        }

        async function runEdit(urls, prompt, format) {
            const form = new FormData();
            form.append("Prompt", prompt);
            if (format) form.append("OutputFormat", format);
            urls.forEach(url => form.append("ImageUrls", url));

            const res = await fetch(`${API}/api/fal/nano-banana/image-edit-form`, {
                method: "POST",
                headers: { Authorization: `Bearer ${getToken()}` },
                body: form
            });

            if (!res.ok) {
                const err = await res.text();
                throw new Error(err);
            }

            return await res.blob();
        }

        document.getElementById("runBtn").addEventListener("click", async () => {
            const status = document.getElementById("status");
            const result = document.getElementById("result");

            try {
                result.innerHTML = "";
                status.textContent = "";

                const token = getToken();
                if (!token) {
                    alert("Token gerekli");
                    return;
                }

                const files = Array.from(document.getElementById("files").files);
                if (!files.length) {
                    alert("Dosya seç");
                    return;
                }

                const prompt = document.getElementById("prompt").value.trim();
                if (!prompt) {
                    alert("Prompt gerekli");
                    return;
                }

                // Upload
                status.textContent = "Yükleniyor...";
                const urls = [];
                for (const f of files) {
                    const url = await uploadFile(f);
                    urls.push(url);
                    console.log("Uploaded:", url);
                }

                // Edit
                status.textContent = "İşleniyor...";
                const format = document.getElementById("format").value;
                const blob = await runEdit(urls, prompt, format);

                // Show
                const img = document.createElement("img");
                img.src = URL.createObjectURL(blob);
                result.appendChild(img);

                status.textContent = "Tamamlandı";
                status.style.color = "green";
            } catch (e) {
                console.error(e);
                status.textContent = "Hata: " + e.message;
                status.style.color = "red";
            }
        });
    </script>
}